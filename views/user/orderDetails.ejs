<%- include('../layouts/header') %>

<div class="page-wrapper">

  <%- include('../layouts/navbar-2.ejs') %>

  <main class="main">

        <div class="page-header text-center" style="background-image: url(assets/images/urban/show.jpg)">
            <div class="container">
                <h1 class="page-title text-white">Order Details</h1>
            </div><!-- End .container -->
        </div><!-- End .page-header -->

        <nav aria-label="breadcrumb" class="breadcrumb-nav mb-3">
            <div class="container">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="">Home</a></li>
                    <!-- <li class="breadcrumb-item"><a href="#"></a></li> -->
                    <li class="breadcrumb-item active" aria-current="page">Orders</li>
                </ol>
            </div><!-- End .container -->
        </nav><!-- End .breadcrumb-nav -->

        <div class="page-content">

              <div class="dashboard">
          
                  <div class="container">

                      <div class="row">

                          <aside class="col-md-4 col-lg-3">

                              <ul class="nav nav-dashboard flex-column mb-3 mb-md-0" role="tablist">

                                  <li class="nav-item">
                                      <a class="nav-link " id="tab-dashboard-link" href="/profile"> My Profile</a>
                                  </li>

                                  <li class="nav-item">
                                      <a class="nav-link active" id="tab-orders-link" href="/orders" role="tab">Orders</a>
                                  </li>

                                  <!-- <li class="nav-item">
                                      <a class="nav-link" id="tab-downloads-link" href="#" role="tab">Wishlist</a>
                                  </li> -->

                                  <li class="nav-item">
                                      <a class="nav-link" id="tab-address-link"  href="/address">Adresses</a>
                                  </li>

                                  <li class="nav-item">
                                      <a class="nav-link" id="tab-wallet-link" data-toggle="tab" href="#" role="tab">Wallet</a>
                                  </li>

                                  <li class="nav-item">
                                      <a class="nav-link" id="tab-coupons-link" data-toggle="tab" href="#" role="tab">Coupons</a>
                                  </li>
                                  
                                  <li class="nav-item">
                                    
                                    <a class="nav-link " href="">Sigout</a>

                                  </li>
                                  
                                </ul>

                            </aside>

                    <div class="col-md-8 col-lg-9">

                        <div class="tab-content">

                             <aside class="col col-xl-9 col-lg-8 col-md-6 col-sm-6 mb-4 mb-lg-0">

                                <div class="row w-100" style="gap: 2rem">

                                    <div class="container">

                    <% if (orderData) { %>
                                
                        <table id="myTable" class="table table-wishlist table-mobile text-center" style="width: 920px">

                                    <thead>

                                        <tr>
                                            <th>No</th>
                                            <th>Product Id</th>
                                            <th>Quantity</th>
                                            <th>Amount</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>

                                    </thead>

                                <tbody class="text-center ">
                                        
                            <% orderData.products.forEach((val , ind)=> {  %>
                                            
                                        <% if(val?.orderProductStatus=='cancelled'){
                                            %>
                                            <tr class="fs-4" style="pointer-events: none; background-color: #f8f9fa; color: gray; ">

                                                        <td><%= ind + 1 %></td>

                                                        <td><%= val?.productId %></td>

                                                        <td><%= val?.quantity %></td>

                                                        <td class=""><%= val?.price %></td>

                                                        <td class=""><%= val?.orderProductStatus %></td>

                                                        <td>

                                                            <div class="dropdown">
                                                                <a
                                                                href="#"
                                                                style="
                                                                    border-radius: 5px;
                                                                    border: 0px solid transparent;
                                                                    outline: 0px;
                                                                    transition: all ease 0.5s;
                                                                    background-color: rgb(122, 122, 125);
                                                                "
                                                                class="p-3 rounded-2 text-white dropdown-toggle"
                                                                role="button"
                                                                id="dropdownMenuLink"
                                                                data-bs-toggle="dropdown"
                                                                aria-expanded="false"
                                                                >
                                                                Actions
                                                                </a>
                                                            
                                                              

                                                        </td>
                                             </tr>

                                                    


                                                        
                                            <%
                                        }
                                        else{
                                            %>

                                                 <tr class="fs-4">

                                                            <td><%= ind + 1 %></td>

                                                            <td><%= val?.productId %></td>

                                                            <td><%= val?.quantity %></td>

                                                            <td class=""><%= val?.price %></td>

                                                            <td class=""><%= val?.orderProductStatus %></td>

                                                            <td>

                                                                <div class="dropdown">
                                                                    <a
                                                                    href="/orderDetails?id=<%= val?._id %>"
                                                                    style="
                                                                        border-radius: 5px;
                                                                        border: 0px solid transparent;
                                                                        outline: 0px;
                                                                        transition: all ease 0.5s;
                                                                        background-color: rgb(54, 6, 247);
                                                                    "
                                                                    class="p-3 rounded-2 text-white dropdown-toggle"
                                                                    role="button"
                                                                    id="dropdownMenuLink"
                                                                    data-bs-toggle="dropdown"
                                                                    aria-expanded="false"
                                                                    >
                                                                    Actions
                                                                    </a>
                                                                
                                                                    <ul class="dropdown-menu bg-dark text-white" aria-labelledby="dropdownMenuLink">
                                                                    
                                                                    <% if(val?.orderProductStatus == 'cancelled'){
                                                                        %>
                                                                        <li></li>
                                                                        <%
                                                                    }
                                                                    else{
                                                                        %>
                                                                        <li><a class="dropdown-item text-danger" href="#" data-bs-toggle="modal" data-bs-target="#cancelModal_<%= ind %>">Cancel</a></li>
                                                                        <li><a class="dropdown-item text-info" href="#">Return</a></li>
                                                                        <%
                                                                    }
                                                                    %>
                                                                    

                                                                    
                                                                    </ul>
                                                                    <!-- Conformation modal for cancelling an order -->
                                                                    
                                                                    <div class="modal fade" id="cancelModal_<%= ind %>" tabindex="-1" aria-labelledby="cancelModalLabel_<%= ind %>" aria-hidden="true">
                                                                        <div class="modal-dialog">
                                                                            <div class="modal-content">
                                                                                <div class="modal-header">
                                                                                    <h5 class="modal-title" id="cancelModalLabel_<%= ind %>">Cancel Order Confirmation</h5>
                                                                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                                                </div>
                                                                                <div class="modal-body">
                                                                                    Are you sure you want to cancel this order?
                                                                                </div>
                                                                                <div class="modal-footer">
                                                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                                                                    <button type="button" onclick="cancelProduct('<%= val.productId  %>','<%= orderData._id  %>','<%= ind %>')" class="btn btn-danger">Cancel Order</button>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    </div>

                                                                </div>
                                                                

                                                            </td>
                                                            </tr>

                                                           

                                                            

                                            <%
                                        }

                                         %>

                                   <% }); %>

                                </tbody>


                        </table>
                        

                    <% } else {  %>

                        <div class="">

                            <p class=" text-primary">Order Not Found</p>
                            
                        </div>

                    <% } %>

                            <% if(orderData) {%>

                                <div class="wishlist-share">

                                    <div class="social-icons social-icons-sm mb-2"> 

                                    <label class="social-label">Total Order:</label>

                                    <%= orderData.products.length %>

                                    </div>

                                    <!-- End .soial-icons -->

                                </div>

                                <!-- <div class="wishlist-share">

                                    <div class="social-icons social-icons-sm mb-2">
                                    <label class="social-label">Total Order:</label>0</div> -->
                                    
                                    <!-- End .soial-icons -->
                                <!-- </div> -->

                            <% } %>

                            </div>

                        </div>

                    </aside>

                              </div>

                          </div><!-- End .col-lg-9 -->
                      </div><!-- End .row -->
                  </div><!-- End .container -->
              </div><!-- End .dashboard -->
            </div>

        </main>

  <!-- Connect Footer -->
  <%- include('../layouts/footbar-2') %>
  <!-- Connect Footer -->

</div>

<button id="scroll-top" title="Back to Top">

  <i class="icon-arrow-up"></i>

</button>

<!--Connect Mobaile View-->
<%- include('../layouts/mobileView.ejs') %>
<!--Connect Mobaile View-->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- Plugins JS File -->
<script src="assets/js/jquery.min.js"></script>
<script src="assets/js/bootstrap.bundle.min.js"></script>
<script src="assets/js/jquery.hoverIntent.min.js"></script>
<script src="assets/js/jquery.waypoints.min.js"></script>
<script src="assets/js/superfish.min.js"></script>
<script src="assets/js/owl.carousel.min.js"></script>
<!-- Main JS File -->
<script src="assets/js/main.js"></script>


<script>



    function cancelProduct(Idd, ordId , index) {
    console.log(Idd, ordId, index);

    fetch(`/cancelProduct?id=${Idd}&ordId=${ordId}&index=${index}`, {
        method: 'GET',
        headers: { 'Content-Type': 'application/json' },
    })
    .then(res => res.json()) // Corrected: Missing parentheses after res.json
    .then(result => {
        if (result === true) {
            console.log('Product cancelled successfully');
            var myModalElement = document.getElementById('cancelModal');
            var modal = bootstrap.Modal.getInstance(myModalElement);
            if (modal) {
                modal.hide();
            }
            // Reload the page or table here
            location.reload(); // Reloads the entire page
            // Or call a function to reload the specific table
            // reloadTable(); // Call a function to reload the specific table
        } else {
            console.error('Failed to cancel product:', result);
        }
    })
    .catch(error => {
        console.error('Error cancelling product:', error);
    });
}

        
</script>

<%- include('../layouts/footer') %>